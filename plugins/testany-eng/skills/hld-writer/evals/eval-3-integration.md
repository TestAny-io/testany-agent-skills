# Eval 3: 第三方集成场景

## 场景描述

接入第三方支付服务的 PRD，需要设计集成方案。测试 skill 对外部依赖、错误处理、降级策略的设计能力。

## 测试输入

- **PRD 文件**：`test-inputs/prd-payment-integration.md`
- **用户指令**：`帮我写这个 PRD 的 HLD`

## 预期行为

### 模板选择

| 步骤 | 预期行为 | 必须/可选 |
|------|---------|----------|
| 识别类型 | 正确识别为「第三方集成」类型 | 必须 |
| 读取模板 | 读取 `assets/integration.md` | 必须 |

### 集成设计要素

| 要素 | 预期行为 | 必须/可选 |
|------|---------|----------|
| 接口契约 | 定义与第三方的接口（请求/响应格式） | 必须 |
| 认证方式 | 说明 API Key / OAuth / 签名等认证机制 | 必须 |
| 错误处理 | 定义第三方错误码映射和处理策略 | 必须 |
| 超时策略 | 策略级描述（如"设置合理超时"），不含具体数值 | 必须 |
| 重试策略 | 策略级描述（如"指数退避重试"），不含具体参数 | 必须 |
| 降级方案 | 第三方不可用时的降级策略 | 必须 |
| 监控告警 | 集成健康度监控方案 | 可选 |

### 安全考量

| 要素 | 预期行为 | 必须/可选 |
|------|---------|----------|
| 密钥管理 | 说明 API Key 等敏感信息的存储方式 | 必须 |
| 数据脱敏 | 日志中敏感数据的处理 | 可选 |
| 传输安全 | HTTPS、证书校验等 | 必须 |

## 评分标准

| 维度 | 权重 | 通过条件 | 得分 |
|------|------|---------|------|
| **模板选择正确** | 10% | 使用 integration.md 模板 | /10 |
| **接口契约完整** | 20% | 请求/响应格式清晰 | /20 |
| **错误处理设计** | 20% | 错误码映射和处理策略 | /20 |
| **容错策略** | 15% | 超时、重试、降级策略完整 | /15 |
| **安全设计** | 15% | 密钥管理、传输安全 | /15 |
| **边界正确** | 10% | 策略级描述，无具体参数 | /10 |
| **需求映射** | 10% | PRD 需求都有对应 | /10 |
| **总分** | 100% | | /100 |

## 常见失败模式

| 失败模式 | 扣分 | 如何检测 |
|---------|------|---------|
| 模板选择错误 | -10 | 使用了 new-feature 模板 |
| 接口契约缺失 | -20 | 未定义与第三方的接口格式 |
| 无错误处理 | -20 | 未考虑第三方返回错误的情况 |
| 无降级方案 | -15 | 未考虑第三方不可用的情况 |
| 越界到 LLD | -10 | 包含具体超时值、重试次数 |
| 密钥硬编码 | -15 | 未说明密钥安全存储方式 |

## 集成设计检查点

### 正确示例（HLD 级别）

```markdown
### 超时与重试策略
- 调用第三方接口设置合理超时，避免长时间阻塞
- 对可重试错误（网络超时、5xx）采用指数退避重试
- 对不可重试错误（4xx、业务拒绝）直接返回

### 降级策略
- 当第三方服务不可用时，订单进入「待支付确认」状态
- 后台任务定期重试未完成的支付
- 超过最大重试次数后通知人工介入
```

### 错误示例（越界到 LLD）

```markdown
### 超时与重试策略
- 超时时间：3000ms
- 最大重试次数：3
- 退避基数：100ms
- 退避因子：2
```

## 测试记录模板

```markdown
## 测试记录

- **测试日期**：YYYY-MM-DD
- **测试模型**：Haiku / Sonnet / Opus
- **skill 版本**：vX.X

### 评分

| 维度 | 得分 | 备注 |
|------|------|------|
| 模板选择正确 | /10 | |
| 接口契约完整 | /20 | |
| 错误处理设计 | /20 | |
| 容错策略 | /15 | |
| 安全设计 | /15 | |
| 边界正确 | /10 | |
| 需求映射 | /10 | |
| **总分** | /100 | |

### 发现的问题

1. [问题描述]

### 改进建议

1. [建议]
```
