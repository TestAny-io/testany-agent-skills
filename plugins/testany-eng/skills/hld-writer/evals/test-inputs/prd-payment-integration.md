# PRD: 支付宝支付集成

> **用于 eval-3-integration 测试**

## 文档信息

| 属性 | 值 |
|------|-----|
| PRD 编号 | PRD-003 |
| 版本 | v1.0 |
| 状态 | 已批准 |

---

## 1. 背景与目标

### 1.1 业务背景

当前系统仅支持线下付款，用户体验差，收款效率低。需要接入支付宝在线支付能力。

### 1.2 产品目标

接入支付宝支付，支持：
- 扫码支付（PC 端）
- H5 支付（移动端）
- 支付结果实时通知

### 1.3 成功指标

| 指标 | 目标值 | 数据来源 |
|------|--------|----------|
| 支付成功率 | > 98% | 支付宝对账 |
| 支付完成时长 | < 30s（P95） | 埋点统计 |
| 对账准确率 | 100% | 人工核对 |

---

## 2. 功能需求

### FR-001 发起支付

**用户故事**：作为用户，我希望能够使用支付宝支付订单。

**验收标准**：
- PC 端显示支付宝支付二维码
- 移动端跳转支付宝 APP 或 H5 页面
- 支付金额与订单金额一致
- 支持订单超时自动取消（30 分钟）

### FR-002 支付结果处理

**用户故事**：作为用户，我希望支付后立即看到结果。

**验收标准**：
- 支付成功后订单状态变为「已支付」
- 支付失败后可重新支付
- 前端实时显示支付结果（轮询 + 异步通知）

### FR-003 支付回调

**验收标准**：
- 接收支付宝异步通知
- 验证签名，防止伪造
- 幂等处理，防止重复通知
- 返回正确响应，避免支付宝重发

### FR-004 退款

**用户故事**：作为运营，我希望能够对已支付订单发起退款。

**验收标准**：
- 支持全额退款和部分退款
- 退款到原支付账户
- 退款状态可查询

### FR-005 对账

**验收标准**：
- 每日自动下载支付宝对账单
- 与本地订单核对
- 差异订单标记并通知

---

## 3. 非功能需求

### NFR-001 性能

- 发起支付接口 P99 < 500ms
- 支付回调处理 P99 < 100ms

### NFR-002 安全

- API 调用使用 RSA2 签名
- 敏感配置（AppID、密钥）安全存储
- 回调验签，防止伪造请求
- 所有通信使用 HTTPS

### NFR-003 可用性

- 支付服务 SLA > 99.9%
- 支付宝不可用时有降级方案

### NFR-004 合规

- 遵守支付宝接口规范
- 保留交易日志至少 3 年

---

## 4. 技术约束

### 4.1 支付宝要求

- 使用支付宝开放平台 SDK（Java/Go）
- 回调地址必须为 HTTPS
- 签名算法：RSA2（SHA256）

### 4.2 方案建议

> 以下为建议方案，最终选型由 HLD 决定

**SDK 选择**：
- 方案 A：官方 SDK —— 稳定但更新慢
- 方案 B：自行封装 —— 灵活但维护成本高

**回调处理**：
- 方案 A：同步处理 —— 简单但可能超时
- 方案 B：异步队列 —— 可靠但复杂度高

---

## 5. 相关能力识别

| 已有能力 | 能力范围 | 匹配度 | 来源 |
|----------|---------|--------|------|
| HTTP Client | 外部 API 调用 | 部分匹配 | `pkg/httpclient/` |
| 消息队列 | 异步任务处理 | 完全匹配 | `pkg/mq/` |
| 定时任务 | 对账任务调度 | 完全匹配 | `pkg/scheduler/` |

---

## 6. 范围

### In-Scope

- 支付宝扫码支付、H5 支付
- 支付回调处理
- 退款
- 对账

### Out-of-Scope

- 微信支付 —— 另一个 PRD
- 银联支付 —— 另一个 PRD
- 分账 —— 后续版本

---

## 7. 风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| 支付宝接口变更 | 低 | 高 | 关注官方公告，预留适配时间 |
| 回调丢失 | 中 | 高 | 主动查询 + 对账兜底 |
| 签名校验失败 | 低 | 中 | 详细日志，便于排查 |
